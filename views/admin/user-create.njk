{% extends "layouts/base.njk" %}

{% block content %}
{% if error %}
	<div class="admin-error">
		<span class="admin-error__icon">üö´</span>
		<h1>{{ error }}</h1>
		<p>You don't have permission to access the admin panel.</p>
		<a href="/ui/admin/users" class="btn btn--primary">Back to Users</a>
	</div>
{% else %}
<div class="admin-page" x-data="userCreateForm()">
	<div class="admin-header">
		<div class="admin-header__nav">
			<a href="/ui/admin/users" class="admin-header__back">‚Üê All Users</a>
		</div>
		<h1 class="admin-header__title">
			<span class="admin-header__icon">‚ûï</span>
			Create User
		</h1>
		<p class="admin-header__subtitle">Add a new user to the platform</p>
	</div>

	<div class="admin-section">
		<form class="admin-form" @submit.prevent="createUser">
			<div class="form-grid">
				<div class="form-group">
					<label for="name" class="form-label">Name *</label>
					<input 
						type="text" 
						id="name" 
						name="name" 
						class="form-input"
						x-model="formData.name"
						placeholder="John Doe"
						required
					/>
				</div>

				<div class="form-group">
					<label for="email" class="form-label">Email *</label>
					<input 
						type="email" 
						id="email" 
						name="email" 
						class="form-input"
						x-model="formData.email"
						placeholder="john@example.com"
						required
					/>
				</div>

				<div class="form-group">
					<label for="password" class="form-label">Password *</label>
					<input 
						type="password" 
						id="password" 
						name="password" 
						class="form-input"
						x-model="formData.password"
						placeholder="Minimum 8 characters"
						minlength="8"
						required
					/>
				</div>

				<div class="form-group">
					<label for="role" class="form-label">Role</label>
					<select id="role" name="role" class="form-select" x-model="formData.role">
						<option value="USER">User</option>
						<option value="ADMIN">Admin</option>
					</select>
				</div>
			</div>

			<div class="form-note">
				<p>* Required fields. The user will be able to log in immediately after creation.</p>
			</div>

			<div class="form-actions">
				<a href="/ui/admin/users" class="btn btn--secondary">Cancel</a>
				<button type="submit" class="btn btn--primary" :disabled="saving">
					<span x-show="!saving">‚ûï Create User</span>
					<span x-show="saving">Creating...</span>
				</button>
			</div>
		</form>
	</div>
</div>

<script>
function userCreateForm() {
	return {
		saving: false,
		formData: {
			name: '',
			email: '',
			password: '',
			role: 'USER'
		},
		async createUser() {
			if (!this.formData.name || !this.formData.email || !this.formData.password) {
				toast.error('Please fill in all required fields');
				return;
			}

			if (this.formData.password.length < 8) {
				toast.error('Password must be at least 8 characters');
				return;
			}

			this.saving = true;
			try {
				const response = await fetch('/admin/users', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(this.formData)
				});
				
				const result = await response.json();
				
				if (response.ok && result.success) {
					toast.success('User created successfully');
					setTimeout(() => {
						window.location.href = '/ui/admin/users/' + result.user.id;
					}, 800);
				} else {
					toast.error(result.message || 'Failed to create user');
				}
			} catch (error) {
				console.error('Error:', error);
				toast.error('Failed to create user');
			} finally {
				this.saving = false;
			}
		}
	};
}
</script>
{% endif %}
{% endblock %}
