{% extends "layouts/base.njk" %}
{% import "exercises/exercise-components.njk" as exerciseComponents %}

{% block content %}
	{# Page Header with Back Button #}
	<div class="page-header page-header--simple">
		<a href="/ui/exercises/{{ exercise.id }}" class="btn-back">‚Üê Back to Exercise</a>
	</div>

	<div class="card form-card form-card--wide">
		<div class="form-header">
			<h1 class="form-header__title">Edit Exercise</h1>
			<p class="form-header__subtitle">Update exercise details</p>
		</div>

		{# Progress bar for file uploads #}
		<div class="upload-progress" id="upload-progress" style="display: none;">
			<div class="upload-progress__bar">
				<div class="upload-progress__fill" id="progress-fill"></div>
			</div>
			<span class="upload-progress__text" id="progress-text">Uploading...</span>
		</div>

		<form
			id="exercise-edit-form"
			class="exercise-form"
			enctype="multipart/form-data"
			hx-patch="/exercises/update/{{ exercise.id }}"
			hx-encoding="multipart/form-data"
			hx-trigger="submit"
			hx-swap="none"
			hx-disabled-elt="button[type='submit']"
			hx-on::before-request="
				document.getElementById('upload-progress').style.display = 'flex';
			"
			hx-on::after-request="
				document.getElementById('upload-progress').style.display = 'none';
				if (event.detail.xhr.status === 200) {
					toast.success('Exercise updated!');
					setTimeout(function() { window.location = '/ui/exercises/{{ exercise.id }}'; }, 500);
				} else {
					try {
						const err = JSON.parse(event.detail.xhr.responseText);
						const fields = err.fields ? Object.values(err.fields).flat().join(', ') : '';
						toast.error((err.message || 'Update failed') + (fields ? ': ' + fields : ''));
					} catch(e) {
						toast.error('Update failed');
					}
				}"
			hx-on::xhr:progress="
				const pct = Math.round((event.detail.loaded / event.detail.total) * 100);
				document.getElementById('progress-fill').style.width = pct + '%';
				document.getElementById('progress-text').textContent = pct + '% uploaded';
			"
		>
			{# Hidden collection ID #}
			<input type="hidden" name="collectionId" value="{{ exercise.collectionId }}" />

			{# Question & Answer Section #}
			<div class="form-section">
				<div class="form-section__header">
					<h2 class="form-section__title">Question & Answer</h2>
					{{ exerciseComponents.typeSelect(name="type", selected=exercise.type) }}
				</div>
				<div class="form-row">
					{{ exerciseComponents.questionInput(name="question", value=exercise.question) }}
					{{ exerciseComponents.translationInput(name="translation", value=exercise.translation) }}
				</div>
				<div class="form-row">
					{{ exerciseComponents.correctAnswerInput(name="correctAnswer", value=exercise.correctAnswer) }}
				</div>
			</div>

			{# Answer Variations #}
			<div class="form-section">
				<h2 class="form-section__title">Answer Variations</h2>
				<div class="form-row form-row--half">
					{{ exerciseComponents.tagsInput(
						name='additionalCorrectAnswers',
						label='Also Accept These Answers',
						placeholder='Type and press Enter...',
						value=exercise.additionalCorrectAnswers,
						tagVariant='success'
					) }}
					{{ exerciseComponents.tagsInput(
						name='distractors',
						label='Wrong Choices (Distractors)',
						placeholder='Type and press Enter...',
						value=exercise.distractors,
						tagVariant='danger'
					) }}
				</div>
			</div>

			{# Media Attachments #}
			<div class="form-section">
				<h2 class="form-section__title">Media Attachments</h2>
				<p class="form-section__hint">Optional image and audio to accompany the exercise</p>
				<div class="form-row form-row--half">
					{{ exerciseComponents.imageUpload(
						name="image",
						currentUrl=exercise.imageUrl,
						showRemove=true
					) }}
					{{ exerciseComponents.audioUpload(
						name="audio",
						currentUrl=exercise.audioUrl,
						showRemove=true
					) }}
				</div>
			</div>

			{# Explanation #}
			<div class="form-section">
				<h2 class="form-section__title">Explanation</h2>
				{{ exerciseComponents.explanationInput(name="explanation", value=exercise.explanation) }}
			</div>

			{# Form Actions #}
			<div class="form-actions">
				<a href="/ui/exercises/{{ exercise.id }}" class="btn-outline">Cancel</a>
				<button type="submit" class="btn-primary">Save Changes</button>
			</div>
		</form>
	</div>

	{# Image Preview Modal #}
	<div id="image-modal" class="modal" onclick="closeImageModal(event)">
		<div class="modal__content">
			<button class="modal__close" onclick="closeImageModal(event)">&times;</button>
			<img id="modal-image" src="" alt="Full size image" />
		</div>
	</div>

	<script>
		function openImageModal(src) {
			document.getElementById('modal-image').src = src;
			document.getElementById('image-modal').classList.add('modal--open');
			document.body.style.overflow = 'hidden';
		}
		function closeImageModal(event) {
			if (event.target.id === 'image-modal' || event.target.classList.contains('modal__close')) {
				document.getElementById('image-modal').classList.remove('modal--open');
				document.body.style.overflow = '';
			}
		}
		document.addEventListener('keydown', function(e) {
			if (e.key === 'Escape') {
				const modal = document.getElementById('image-modal');
				if (modal) {
					modal.classList.remove('modal--open');
					document.body.style.overflow = '';
				}
			}
		});
	</script>
{% endblock %}
