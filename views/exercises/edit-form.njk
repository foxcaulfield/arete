{% extends "layouts/base.njk" %}
{% import "exercises/exercise-components.njk" as exerciseComponents %}

{% block content %}
	<div class="container card">
		<h1>Edit Exercise</h1>
		<progress id="progress" value="0" max="100"></progress>

		<form
			id="exercise-edit-form"
			enctype="multipart/form-data"
			hx-patch="/exercises/update/{{ exercise.id }}"
			hx-encoding="multipart/form-data"
			hx-trigger="submit"
			hx-swap="none"
			hx-disabled-elt="this"
			hx-on::after-request="
    if (event.detail.xhr.status === 200) {
      window.location = '/ui/exercises/{{ exercise.id }}';
    } else {
      try {
        const err = JSON.parse(event.detail.xhr.responseText);
        const fields = err.fields ? Object.values(err.fields).flat().join(', ') : '';
        document.getElementById('exercise-edit-errors').textContent =
          (err.message || 'Update failed') + (fields ? ' — ' + fields : '');
      } catch(e) {
        document.getElementById('exercise-edit-errors').textContent = 'Update failed';
      }
    }"
			hx-on::xhr:progress="
                    const progress = document.getElementById('progress');
                    progress.value = (event.detail.loaded / event.detail.total) * 100;
                "
		>
			<div id="form-content">
				{# GRID ITEM A #}
				<div class="grid-item" style="--area: a;">
					{{
						exerciseComponents.collectionIdInput(
						    id=collectionId or exercise.collectionId,
						    name="collectionId"
						)
					}}
				</div>

				{# GRID ITEM O #}
				<div class="grid-item-o">
					{{
						exerciseComponents.typeSelect(
						    name="type",
						    selected=exercise.type
						)
					}}
				</div>

				{# GRID ITEM B #}
				<div class="grid-item-b flex-row">
					{{ exerciseComponents.questionText(name="question", value=exercise.question) }}
					{{ exerciseComponents.translationText(name="translation", value=exercise.translation) }}
				</div>

				{# GRID ITEM C #}
				<div class="grid-item" style="--area: c;">
					{{ exerciseComponents.correctAnswerInput(name="correctAnswer", value=exercise.correctAnswer) }}
				</div>

				{# GRID ITEM D #}
				<div class="grid-item-d">
					{# additional correct answers #}
					{{
						exerciseComponents.additionalCorrectAnswersInput(
						    name='additionalCorrectAnswers',
						    label='Additional Correct Answers',
						    placeholder='paris, PARIS, Île de France...',
						    value=exercise.additionalCorrectAnswers
						)
					}}
				</div>

				{# GRID ITEM E #}
				<div class="grid-item-e">
					{# distractors #}
					{{
						exerciseComponents.distractionAnswersInput(
						    name='distractors',
						    label='Wrong Answers',
						    placeholder='london, berlin, madrid...',
						    value=exercise.distractors
						)
					}}
				</div>

				{# GRID ITEM F #}
				<div class="grid-item-f flex-row">
					{{ exerciseComponents.explanationText(name="explanation", value=exercise.explanation) }}
					{{
						exerciseComponents.imageInput(
						    name="image",
						    label="Image (optional)",
						    withClearButton=false,
						    withSetNullButton=true,
						    currentImageUrl=exercise.imageUrl
						)
					}}
					{{
						exerciseComponents.audioInput(
						    name="audio",
						    label="Audio (optional)",
						    withClearButton=false,
						    withSetNullButton=true,
						    currentAudioUrl=exercise.audioUrl
						)
					}}
				</div>

				{# GRID ITEM BUTTONS #}
				<div class="grid-item-btn">
					<div class="form-group">
						<button type="submit">Save</button>
						<button type="button" onclick="window.location.href='/ui/exercises/{{ exercise.id }}'">
							Cancel
						</button>
					</div>
				</div>
			</div>

			<div id="exercise-edit-errors" class="error mt"></div>
			{# <div class="mt">
        <button type="submit">Save</button>
        <button type="button" onclick="window.location.href='/ui/exercises/{{ exercise.id }}'">Cancel</button>
    </div> #}
		</form>
		<style>
			:root {
				--success-bg: #ecfdf0;
				--success-text: #14532d;
				--danger-bg: #fff2f2;
				--danger-text: #7f1d1d;
			}

			.tag,
			#distractors-container div {
				display: inline-flex;
				align-items: center;
				gap: 0.4rem;
				padding: 0.25rem 0.6rem;
				margin: 4px 6px;
				border-radius: 9999px;
				font-size: 0.95rem;
				border: 1px solid;
			}

			#additional-correct-answers-container .tag {
				background: var(--success-bg);
				color: var(--success-text);
				border-color: #86efac;
			}

			#distractors-container div {
				background: var(--danger-bg);
				color: var(--danger-text);
				border-color: #fca5a5;
			}

			.tag button,
			#distractors-container div button {
				border: none;
				background: transparent;
				color: inherit;
				cursor: pointer;
				padding: 0 6px;
				font-size: 1.05rem;
			}

			#additional-correct-answers-input > div,
			#distractors-input > div {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				margin-bottom: 0.5rem;
			}

			#additional-correct-answers-input > div button,
			#distractors-input > div button {
				padding: 0.25rem 0.5rem;
				border: 1px solid #e5e7eb;
				background: #fff;
				color: #6b7280;
				cursor: pointer;
				border-radius: 4px;
			}

			#form-content {
				display: grid;
				grid-template-columns: repeat(6, 1fr);
				grid-template-areas:
					"a a b b b b"
					"o o c c c c"
					"d d e e e e"
					"f f f f f f"
					"btn btn btn btn btn btn";
				gap: 1rem 1.5rem;
			}

			.grid-item-a {
				grid-area: a;
			}

			.grid-item-o {
				grid-area: o;
			}

			.grid-item-b {
				grid-area: b;
			}

			.grid-item-c {
				grid-area: c;
			}

			.grid-item-d {
				grid-area: d;
			}

			.grid-item-e {
				grid-area: e;
			}

			.grid-item-f {
				grid-area: f;
			}

			.grid-item-btn {
				grid-area: btn;
			}

			.flex-row {
				display: flex;
				flex-direction: row;
				gap: 1rem;
			}
		</style>
	</div>
{% endblock %}
