{% extends "layouts/base.njk" %}
{% import "exercises/exercise-components.njk" as exerciseComponents %}

{% block content %}
	<div class="container card">
		<h1>Edit Exercise</h1>
		<progress id="progress" value="0" max="100"></progress>

		<form
			id="exercise-edit-form"
			enctype="multipart/form-data"
			hx-patch="/exercises/update/{{ exercise.id }}"
			hx-encoding="multipart/form-data"
			hx-trigger="submit"
			hx-swap="none"
			hx-disabled-elt="this"
			hx-on::after-request="
    if (event.detail.xhr.status === 200) {
      window.location = '/ui/exercises/{{ exercise.id }}';
    } else {
      try {
        const err = JSON.parse(event.detail.xhr.responseText);
        const fields = err.fields ? Object.values(err.fields).flat().join(', ') : '';
        document.getElementById('exercise-edit-errors').textContent =
          (err.message || 'Update failed') + (fields ? ' — ' + fields : '');
      } catch(e) {
        document.getElementById('exercise-edit-errors').textContent = 'Update failed';
      }
    }"
			hx-on::xhr:progress="
                    const progress = document.getElementById('progress');
                    progress.value = (event.detail.loaded / event.detail.total) * 100;
                "
		>
			<div class="form-content">
				{# GRID ITEM A #}
				<div class="grid-item" style="--area: a;">
					{{
						exerciseComponents.collectionIdInput(
						    id=collectionId or exercise.collectionId,
						    name="collectionId"
						)
					}}
				</div>

				{# GRID ITEM O #}
				<div class="grid-item" style="--area: o;">
					{{
						exerciseComponents.typeSelect(
						    name="type",
						    selected=exercise.type
						)
					}}
				</div>

				{# GRID ITEM B #}
				<div class="grid-item flex-row" style="--area: b;">
					{{ exerciseComponents.questionText(name="question", value=exercise.question) }}
					{{ exerciseComponents.translationText(name="translation", value=exercise.translation) }}
				</div>

				{# GRID ITEM C #}
				<div class="grid-item" style="--area: c;">
					{{ exerciseComponents.correctAnswerInput(name="correctAnswer", value=exercise.correctAnswer) }}
				</div>

				{# GRID ITEM D #}
				<div class="grid-item" style="--area: d;">
					{# additional correct answers #}
					{{
						exerciseComponents.additionalCorrectAnswersInput(
						    name='additionalCorrectAnswers',
						    label='Additional Correct Answers',
						    placeholder='paris, PARIS, Île de France...',
						    value=exercise.additionalCorrectAnswers
						)
					}}
				</div>

				{# GRID ITEM E #}
				<div class="grid-item" style="--area: e;">
					{# distractors #}
					{{
						exerciseComponents.distractionAnswersInput(
						    name='distractors',
						    label='Wrong Answers',
						    placeholder='london, berlin, madrid...',
						    value=exercise.distractors
						)
					}}
				</div>

				{# GRID ITEM F #}
				<div class="grid-item flex-row" style="--area: f;">
					{{ exerciseComponents.explanationText(name="explanation", value=exercise.explanation) }}
					{{
						exerciseComponents.imageInput(
						    name="image",
						    label="Image (optional)",
						    withClearButton=false,
						    withSetNullButton=true,
						    currentImageUrl=exercise.imageUrl
						)
					}}
					{{
						exerciseComponents.audioInput(
						    name="audio",
						    label="Audio (optional)",
						    withClearButton=false,
						    withSetNullButton=true,
						    currentAudioUrl=exercise.audioUrl
						)
					}}
				</div>

				{# GRID ITEM BUTTONS #}
				<div class="grid-item" style="--area: btn;">
					<div class="form-group">
						<button type="submit">Save</button>
						<button type="button" onclick="window.location.href='/ui/exercises/{{ exercise.id }}'">
							Cancel
						</button>
					</div>
				</div>
			</div>

			<div id="exercise-edit-errors" class="error mt"></div>
		</form>
	</div>
{% endblock %}
