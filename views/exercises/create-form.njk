{% extends "layouts/base.njk" %}
{% import "exercises/exercise-components.njk" as exerciseComponents %}

{% block content %}
	<div class="container card">
		<h1>Create New Exercise</h1>
		<progress id="progress" value="0" max="100"></progress>

		<form
			id="exercise-create-form"
			hx-post="/exercises/create"
			hx-encoding="multipart/form-data"
			hx-trigger="submit"
			hx-swap="none"
			hx-on::after-request="
                    if (event.detail.successful) {
                        try {
                            const ex = JSON.parse(event.detail.xhr.responseText);
                            // Prefer redirect to its collection detail
                            window.location = '/ui/collections/' + ex.collectionId;
                        } catch(e) {
                            // Fallback to collections page if parsing fails
                            window.location = '/ui/collections';
                        }
                    } else {
                        try {
                            const err = JSON.parse(event.detail.xhr.responseText);
                            const fields = err.fields ? Object.values(err.fields).flat().join(', ') : '';
                            document.getElementById('exercise-form-errors').textContent =
                            (err.message || 'Create failed') + (fields ? ' â€” ' + fields : '');
                        } catch(e) {
                            document.getElementById('exercise-form-errors').textContent = 'Create failed';
                        }
                    }"
			hx-on::xhr:progress="
                    const progress = document.getElementById('progress');
                    progress.value = (event.detail.loaded / event.detail.total) * 100;
                "
		>
			<div id="form-content">
				{# GRID ITEM A #}
				<div class="grid-item" style="--area: a;">
					{{ exerciseComponents.collectionIdInput(id=collectionId, name="collectionId") }}
				</div>

				{# GRID ITEM O #}
				<div class="grid-item" style="--area: o;">{{ exerciseComponents.typeSelect(name="type") }}</div>

				{# GRID ITEM B #}
				<div class="grid-item flex-row" style="--area: b;">
					{{ exerciseComponents.questionText(name="question") }}
					{{ exerciseComponents.translationText(name="translation") }}
				</div>

				{# GRID ITEM C #}
				<div class="grid-item" style="--area: c;">
					{{ exerciseComponents.correctAnswerInput(name="correctAnswer") }}
				</div>

				{# GRID ITEM D #}
				<div class="grid-item" style="--area: d;">
					{# additional correct answers #}
					{{
						exerciseComponents.additionalCorrectAnswersInput(
                            name='additionalCorrectAnswers',
                            label='Additional Correct Answers'
						)
					}}
				</div>

				{# GRID ITEM E #}
				<div class="grid-item" style="--area: e;">
					{# distractors #}
					{{
						exerciseComponents.distractionAnswersInput(
						    name='distractors',
						    label='Wrong Answers'
						)
					}}
				</div>

				{# GRID ITEM F #}
				<div class="grid-item flex-row" style="--area: f;">
					{{ exerciseComponents.explanationText(name="explanation") }}
					{{ exerciseComponents.imageInput(name="image", label="Image (optional)", withClearButton=true) }}
					{{ exerciseComponents.audioInput(name="audio", label="Audio (optional)", withClearButton=true) }}
				</div>

				{# GRID ITEM BUTTONS #}
				<div class="grid-item" style="--area: btn;">{{ exerciseComponents.actionButtons(collectionId) }}</div>
			</div>
			<div id="exercise-form-errors"></div>
		</form>
		<style>
			#form-content {
				display: grid;
				grid-template-columns: repeat(6, 1fr);
				grid-template-areas:
					"a a b b b b"
					"o o c c c c"
					"d d e e e e"
					"f f f f f f"
					"btn btn btn btn btn btn";
				gap: 1rem 1.5rem;
			}

			.grid-item {
				grid-area: var(--area);
				border-radius: 4px;
				box-sizing: border-box;
			}
		</style>
	</div>
{% endblock %}
