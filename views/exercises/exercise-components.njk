{# =============================================
   EXERCISE FORM COMPONENTS
   Modern, clean design with consistent styling
   ============================================= #}

{# --------------------------------------------
   TYPE SELECT
   -------------------------------------------- #}
{% macro typeSelect(name, selected) %}
	<div class="type-select" x-data="{ selected: '{{ selected | default('FILL_IN_THE_BLANK') }}' }">
		<label class="type-chip">
			<input 
				type="radio" 
				name="{{ name }}" 
				value="FILL_IN_THE_BLANK" 
				x-model="selected"
				{% if selected != 'CHOICE_SINGLE' %}checked{% endif %}
			/>
			<span class="type-chip__body" :class="{ 'type-chip__body--active': selected === 'FILL_IN_THE_BLANK' }">
				<span class="type-chip__icon">‚úèÔ∏è</span>
				<span class="type-chip__label">Fill in the Blank</span>
			</span>
		</label>
		<label class="type-chip">
			<input 
				type="radio" 
				name="{{ name }}" 
				value="CHOICE_SINGLE" 
				x-model="selected"
				{% if selected == 'CHOICE_SINGLE' %}checked{% endif %}
			/>
			<span class="type-chip__body" :class="{ 'type-chip__body--active': selected === 'CHOICE_SINGLE' }">
				<span class="type-chip__icon">üîò</span>
				<span class="type-chip__label">Multiple Choice</span>
			</span>
		</label>
		{# Future types can be added here easily #}
		{#
		<label class="type-chip">
			<input type="radio" name="{{ name }}" value="MATCHING" x-model="selected" />
			<span class="type-chip__body" :class="{ 'type-chip__body--active': selected === 'MATCHING' }">
				<span class="type-chip__icon">üîó</span>
				<span class="type-chip__label">Matching</span>
			</span>
		</label>
		#}
	</div>
{% endmacro %}

{# --------------------------------------------
   QUESTION INPUT
   -------------------------------------------- #}
{% macro questionInput(name, value="") %}
	<div class="form-group form-group--flex">
		<label for="question-{{ name }}" class="form-label">
			Question <span class="required">*</span>
		</label>
		<input 
			type="text" 
			name="{{ name }}" 
			id="question-{{ name }}" 
			class="form-input"
			value="{{ value }}"
			placeholder="e.g., The capital of France is {% raw %}{{Paris}}{% endraw %}"
			required
			autocomplete="off"
		/>
	</div>
{% endmacro %}

{# --------------------------------------------
   TRANSLATION INPUT
   -------------------------------------------- #}
{% macro translationInput(name, value="") %}
	<div class="form-group">
		<label for="translation-{{ name }}" class="form-label">Translation</label>
		<input 
			type="text" 
			name="{{ name }}" 
			id="translation-{{ name }}" 
			class="form-input"
			value="{{ value }}"
			placeholder="Optional translation or hint"
			autocomplete="off"
		/>
	</div>
{% endmacro %}

{# --------------------------------------------
   CORRECT ANSWER INPUT
   -------------------------------------------- #}
{% macro correctAnswerInput(name, value="") %}
	<div class="form-group">
		<label for="answer-{{ name }}" class="form-label">
			Correct Answer <span class="required">*</span>
		</label>
		<input 
			type="text" 
			name="{{ name }}" 
			id="answer-{{ name }}" 
			class="form-input form-input--highlight"
			value="{{ value }}"
			placeholder="The correct answer"
			required
			autocomplete="off"
		/>
	</div>
{% endmacro %}

{# --------------------------------------------
   EXPLANATION INPUT
   -------------------------------------------- #}
{% macro explanationInput(name, value="") %}
	<div class="form-group">
		<label for="explanation-{{ name }}" class="form-label">Explanation</label>
		<textarea 
			name="{{ name }}" 
			id="explanation-{{ name }}"
			class="form-input"
			rows="3"
			placeholder="Optional explanation shown after answering"
		>{{ value }}</textarea>
		<span class="form-hint">Help users understand why this is the correct answer</span>
	</div>
{% endmacro %}

{# --------------------------------------------
   TAGS INPUT (for additional answers & distractors)
   -------------------------------------------- #}
{% macro tagsInput(name, label, placeholder="Type and press Enter...", value=[], tagVariant='default') %}
	<div class="form-group tags-input-group" x-data="{ input: '', tags: {{ value | dump | default('[]') }} }">
		<div class="form-label-row">
			<label class="form-label">{{ label }}</label>
			<button 
				type="button" 
				class="btn-text btn-text--sm" 
				@click="tags = []"
				:style="tags.length === 0 ? 'visibility: hidden' : ''"
			>Clear all</button>
		</div>

		<div class="tags-input-wrapper">
			<input
				type="text"
				class="form-input"
				placeholder="{{ placeholder }}"
				x-model="input"
				@keydown.enter.prevent="
					let v = input.trim();
					if (v && !tags.includes(v)) {
						tags.push(v);
						input = '';
					}
				"
				@keydown.comma.prevent="
					let v = input.trim().replace(/,$/, '');
					if (v && !tags.includes(v)) {
						tags.push(v);
						input = '';
					}
				"
			/>
			<span class="form-hint">Press Enter or comma to add</span>
		</div>

		{# Always send field - empty string when no tags (signals "clear") #}
		<template x-if="tags.length === 0">
			<input type="hidden" name="{{ name }}" value="" />
		</template>

		<div class="tags-container">
			<template x-for="(tag, index) in tags" :key="index">
				<span class="tag tag--{{ tagVariant }} tag--removable">
					<input type="hidden" name="{{ name }}" :value="tag" />
					<span x-text="tag"></span>
					<button type="button" class="tag__remove" @click="tags.splice(index, 1)">√ó</button>
				</span>
			</template>
		</div>
	</div>
{% endmacro %}

{# --------------------------------------------
   IMAGE UPLOAD
   -------------------------------------------- #}
{% macro imageUpload(name, currentUrl="", showRemove=false) %}
	<div 
		class="media-upload" 
		x-data="{ 
			previewSrc: '{{ ('/exercises/files/image/' ~ currentUrl) if currentUrl else '' }}',
			originalSrc: '{{ ('/exercises/files/image/' ~ currentUrl) if currentUrl else '' }}',
			fileName: '',
			setNull: false,
			hasNewFile: false
		}"
	>
		<div class="media-upload__header">
			<span class="media-upload__icon">üì∑</span>
			<span class="media-upload__title">Image</span>
			{% if showRemove %}
				<label class="media-upload__set-null" x-show="originalSrc && !hasNewFile">
					<input 
						type="checkbox" 
						name="setNullImage" 
						x-model="setNull"
						@change="if(setNull) { previewSrc = ''; } else { previewSrc = originalSrc; }"
					/>
					<span>Remove</span>
				</label>
			{% endif %}
		</div>

		<input
			type="file"
			name="{{ name }}"
			accept="image/*"
			x-ref="fileInput"
			style="display: none;"
			@change="
				const file = $event.target.files[0];
				if (!file) {
					hasNewFile = false;
					fileName = '';
					previewSrc = originalSrc;
					return;
				}
				hasNewFile = true;
				setNull = false;
				fileName = file.name;
				const reader = new FileReader();
				reader.onload = (e) => { previewSrc = e.target.result; };
				reader.readAsDataURL(file);
			"
		/>

		{# Preview or Upload Area - Fixed Height #}
		<div class="media-upload__dropzone" @click="$refs.fileInput.click()">
			<template x-if="previewSrc && !setNull">
				<div class="media-upload__preview">
					<img :src="previewSrc" alt="Preview" @click.stop="openImageModal(previewSrc)" />
					<div class="media-upload__preview-overlay" @click.stop="openImageModal(previewSrc)">
						<span>üîç Click to preview</span>
					</div>
				</div>
			</template>
			<template x-if="!previewSrc || setNull">
				<div class="media-upload__placeholder">
					<span class="media-upload__placeholder-text">Click to upload image</span>
					<span class="media-upload__placeholder-hint">JPG, PNG, GIF up to 5MB</span>
				</div>
			</template>
		</div>

		{# File name & clear button for NEW files only #}
		<div class="media-upload__actions" :style="!hasNewFile ? 'visibility: hidden' : ''">
			<span class="media-upload__filename" x-text="fileName"></span>
			<button 
				type="button" 
				class="btn-text btn-text--danger btn-text--sm"
				@click="
					$refs.fileInput.value = '';
					hasNewFile = false;
					fileName = '';
					previewSrc = originalSrc;
				"
			>Clear</button>
		</div>
	</div>
{% endmacro %}

{# --------------------------------------------
   AUDIO UPLOAD
   -------------------------------------------- #}
{% macro audioUpload(name, currentUrl="", showRemove=false) %}
	<div 
		class="media-upload" 
		x-data="{ 
			audioSrc: '{{ ('/exercises/files/audio/' ~ currentUrl) if currentUrl else '' }}',
			originalSrc: '{{ ('/exercises/files/audio/' ~ currentUrl) if currentUrl else '' }}',
			fileName: '',
			setNull: false,
			hasNewFile: false
		}"
	>
		<div class="media-upload__header">
			<span class="media-upload__icon">üéµ</span>
			<span class="media-upload__title">Audio</span>
			{% if showRemove %}
				<label class="media-upload__set-null" x-show="originalSrc && !hasNewFile">
					<input 
						type="checkbox" 
						name="setNullAudio" 
						x-model="setNull"
						@change="if(setNull) { audioSrc = ''; } else { audioSrc = originalSrc; }"
					/>
					<span>Remove</span>
				</label>
			{% endif %}
		</div>

		<input
			type="file"
			name="{{ name }}"
			accept="audio/*"
			x-ref="fileInput"
			style="display: none;"
			@change="
				const file = $event.target.files[0];
				if (!file) {
					hasNewFile = false;
					fileName = '';
					audioSrc = originalSrc;
					return;
				}
				hasNewFile = true;
				setNull = false;
				fileName = file.name;
				if (audioSrc && audioSrc.startsWith('blob:')) URL.revokeObjectURL(audioSrc);
				audioSrc = URL.createObjectURL(file);
			"
		/>

		{# Upload Area or Player - Fixed Height #}
		<div class="media-upload__dropzone" x-show="!audioSrc || setNull" @click="$refs.fileInput.click()">
			<div class="media-upload__placeholder">
				<span class="media-upload__placeholder-text">Click to upload audio</span>
				<span class="media-upload__placeholder-hint">MP3, WAV, OGG up to 10MB</span>
			</div>
		</div>

		<div class="media-upload__audio-player" x-show="audioSrc && !setNull" @click="$refs.fileInput.click()">
			<audio :src="audioSrc" controls @click.stop></audio>
			<span class="media-upload__audio-hint">Click area to change</span>
		</div>

		{# File name & clear button for NEW files only #}
		<div class="media-upload__actions" :style="!hasNewFile ? 'visibility: hidden' : ''">
			<span class="media-upload__filename" x-text="fileName"></span>
			<button 
				type="button" 
				class="btn-text btn-text--danger btn-text--sm"
				@click="
					$refs.fileInput.value = '';
					if (audioSrc && audioSrc.startsWith('blob:')) URL.revokeObjectURL(audioSrc);
					hasNewFile = false;
					fileName = '';
					audioSrc = originalSrc;
				"
			>Clear</button>
		</div>
	</div>
{% endmacro %}
