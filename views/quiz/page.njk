{% extends "layouts/base.njk" %}

{% block content %}
	<div
		id="quiz-page"
		class="quiz-page"
		x-data="{
			isImageVisible: false,
			isExplanationVisible: false,
			isForceTextInput: false,
			userAnswer: '',
			isSubmitted: false,
			isCorrect: false,
			correctAnswer: '',
			additionalAnswers: [],
			streak: {{ sessionStats.streak }},
			sessionCorrect: {{ sessionStats.correct }},
			sessionTotal: {{ sessionStats.total }},
			lightboxOpen: false,
		}"
		@keydown.escape.window="lightboxOpen = false"
	>
		<div class="quiz-topbar">
			<a href="/ui/collections/{{ collectionId }}" class="quiz-topbar__exit">
				<span class="quiz-topbar__exit-icon">‚Üê</span>
				<span class="quiz-topbar__exit-text">Exit</span>
			</a>
			<div class="quiz-topbar__title">{{ collectionName | truncate(30) }}</div>
			<div class="quiz-topbar__stats">
				<div class="quiz-stat" title="Current streak">
					<span class="quiz-stat__icon">üî•</span>
					<span class="quiz-stat__value" x-text="streak"></span>
				</div>
				<div class="quiz-stat" title="Session score">
					<span class="quiz-stat__icon">‚úì</span>
					<span class="quiz-stat__value"><span x-text="sessionCorrect"></span>/<span x-text="sessionTotal"></span></span>
				</div>
			</div>
		</div>

		{% if quizQuestion.totalExercises > 0 %}
			<div class="quiz-progress">
				<div class="quiz-progress__bar">
                    <div class="quiz-progress__fill" :style="{ width: '{{ (quizQuestion.exercisesWithAttempts / quizQuestion.totalExercises * 100) | round }}%' }"></div>
				</div>
				<span class="quiz-progress__text">{{ quizQuestion.exercisesWithAttempts }}/{{ quizQuestion.totalExercises }} practiced</span>
			</div>
		{% endif %}

		<div 
			id="quiz-card" 
			class="quiz-card"
			:class="{ 'quiz-card--submitted': isSubmitted, 'quiz-card--correct': isSubmitted && isCorrect, 'quiz-card--incorrect': isSubmitted && !isCorrect }"
		>
			{% if quizQuestion.audioUrl %}
				<audio id="exercise-audio" src="/exercises/files/audio/{{ quizQuestion.audioUrl }}" hidden></audio>
			{% endif %}
			<input id="collectionId" value="{{ collectionId }}" type="hidden" />
			<input id="exerciseId" value="{{ quizQuestion.id }}" type="hidden" />

			<div class="quiz-card__header">
				<div class="quiz-card__type">
					{% if quizQuestion.type == 'CHOICE_SINGLE' %}
						<span class="quiz-card__type-icon">üîò</span><span>Multiple Choice</span>
					{% else %}
						<span class="quiz-card__type-icon">‚úèÔ∏è</span><span>Fill in the Blank</span>
					{% endif %}
				</div>
				<div class="quiz-card__actions">
					{% if quizQuestion.imageUrl %}
						<button type="button" class="quiz-action-btn" :class="{ 'quiz-action-btn--active': isImageVisible }" @click="isImageVisible = !isImageVisible" title="Image (I)">üì∑</button>
					{% endif %}
					{% if quizQuestion.audioUrl %}
						<button type="button" class="quiz-action-btn" @click="document.getElementById('exercise-audio')?.play()" title="Audio (A)">üîä</button>
					{% endif %}
					{% if quizQuestion.explanation %}
						<button type="button" class="quiz-action-btn" :class="{ 'quiz-action-btn--active': isExplanationVisible }" @click="isExplanationVisible = !isExplanationVisible" title="Explanation (E)">üí°</button>
					{% endif %}
					{% if quizQuestion.type == 'CHOICE_SINGLE' %}
						<button type="button" class="quiz-action-btn" :class="{ 'quiz-action-btn--active': isForceTextInput }" @click="isForceTextInput = !isForceTextInput; $nextTick(() => $refs.textInput?.focus())" title="Text mode (T)">‚å®Ô∏è</button>
					{% endif %}
					<a href="/ui/exercises/{{ quizQuestion.id }}/edit" class="quiz-action-btn" title="Edit">‚úé</a>
				</div>
			</div>

			<div class="quiz-card__question">
				<h2 class="quiz-question">
					{% set parts = quizQuestion.question | parseQuestion %}
					{% for part in parts %}<span class="quiz-question__part {{ 'quiz-question__part--answer' if part.isAnswer }}">{{ part.text }}</span>{% endfor %}
				</h2>
				{% if quizQuestion.translation %}
					<p class="quiz-translation">{{ quizQuestion.translation }}</p>
				{% endif %}
			</div>

			{% if quizQuestion.imageUrl %}
				<div class="quiz-image" x-show="isImageVisible" x-transition.opacity x-cloak>
					<img src="/exercises/files/image/{{ quizQuestion.imageUrl }}" alt="Exercise image" @click="lightboxOpen = true" style="cursor: zoom-in;" />
				</div>
			{% endif %}

			<div class="quiz-card__answer">
				{% if quizQuestion.type == 'CHOICE_SINGLE' %}
					<div class="quiz-distractors" x-show="!isForceTextInput">
						{% for distractor in quizQuestion.distractors %}
							<button 
								type="button" 
								class="quiz-distractor" 
								:class="{ 'quiz-distractor--selected': userAnswer.toLowerCase() === '{{ distractor | lower }}', 'quiz-distractor--correct': isSubmitted && correctAnswer.toLowerCase() === '{{ distractor | lower }}', 'quiz-distractor--wrong': isSubmitted && !isCorrect && userAnswer.toLowerCase() === '{{ distractor | lower }}' && correctAnswer.toLowerCase() !== '{{ distractor | lower }}' }" 
								:disabled="isSubmitted" 
								@click="userAnswer = '{{ distractor }}'; submitAnswer($data)"
							>
								<span class="quiz-distractor__key" x-show="!isSubmitted">{{ loop.index }}</span>
								<span class="quiz-distractor__text">{{ distractor }}</span>
							</button>
						{% endfor %}
					</div>
					<div class="quiz-text-input" x-show="isForceTextInput" x-cloak>
						<input type="text" class="quiz-input" placeholder="Type your answer..." x-model="userAnswer" :disabled="isSubmitted" @keydown.enter="if (userAnswer.trim() && !isSubmitted) submitAnswer($data)" x-ref="textInput" autocomplete="off" />
						<button type="button" class="quiz-submit-btn" :disabled="!userAnswer.trim() || isSubmitted" @click="submitAnswer($data)">Submit</button>
					</div>
				{% else %}
					<div class="quiz-text-input">
						<input type="text" class="quiz-input" placeholder="Type your answer..." x-model="userAnswer" :disabled="isSubmitted" @keydown.enter="if (userAnswer.trim() && !isSubmitted) submitAnswer($data)" x-ref="textInput" x-init="$nextTick(() => $refs.textInput?.focus())" autocomplete="off" />
						<button type="button" class="quiz-submit-btn" :disabled="!userAnswer.trim() || isSubmitted" @click="submitAnswer($data)">Submit</button>
					</div>
				{% endif %}
			</div>

			<div class="quiz-feedback" x-show="isSubmitted" x-transition x-cloak>
				<div class="quiz-feedback__content" :class="isCorrect ? 'quiz-feedback--correct' : 'quiz-feedback--incorrect'">
					<div class="quiz-feedback__icon">
						<span x-show="isCorrect">‚úì</span>
						<span x-show="!isCorrect">‚úó</span>
					</div>
					<div class="quiz-feedback__text">
						<span x-show="isCorrect" class="quiz-feedback__title">Correct!</span>
						<span x-show="!isCorrect" class="quiz-feedback__title">Incorrect</span>
						<span x-show="!isCorrect" class="quiz-feedback__answer">
							The correct answer is: <strong x-text="correctAnswer"></strong>
							<template x-if="additionalAnswers.length > 0">
								<span class="quiz-feedback__also"> (also: <span x-text="additionalAnswers.join(', ')"></span>)</span>
							</template>
						</span>
					</div>
				</div>
			</div>

			{% if quizQuestion.explanation %}
				<div class="quiz-explanation" x-show="isExplanationVisible" x-transition x-cloak>
					<div class="quiz-explanation__header">üí° Explanation</div>
					<div class="quiz-explanation__content">{{ quizQuestion.explanation | filterMarkdown | safe }}</div>
				</div>
			{% endif %}
		</div>

		<div class="quiz-footer">
			<button type="button" class="quiz-footer__btn quiz-footer__btn--skip" @click="nextQuestion()" :disabled="isSubmitted">
				Skip <span class="quiz-key-hint">S</span>
			</button>
			<button type="button" class="quiz-footer__btn quiz-footer__btn--next" @click="nextQuestion()" :disabled="!isSubmitted" x-ref="nextBtn">
				Next Question <span class="quiz-key-hint">‚Üµ</span>
			</button>
		</div>

		<div x-init="
			document.addEventListener('keydown', (e) => {
				if (e.target.tagName === 'INPUT') return;
				if (e.key === 'Escape') { if (lightboxOpen) { lightboxOpen = false; return; } window.location.href = '/ui/collections/{{ collectionId }}'; }
				if (e.key === 's' && !isSubmitted) nextQuestion();
				if (e.key === 'Enter' && isSubmitted) nextQuestion();
				if (e.key === 'i') isImageVisible = !isImageVisible;
				if (e.key === 'e') isExplanationVisible = !isExplanationVisible;
				if (e.key === 'a') document.getElementById('exercise-audio')?.play();
				if (e.key === 't') { isForceTextInput = !isForceTextInput; $nextTick(() => $refs.textInput?.focus()); }
				if (!isSubmitted && !isForceTextInput && ['1','2','3','4','5','6'].includes(e.key)) {
					const btns = document.querySelectorAll('.quiz-distractor:not([disabled])');
					const idx = parseInt(e.key) - 1;
					if (btns[idx]) btns[idx].click();
				}
			});
		"></div>

		{% if quizQuestion.imageUrl %}
			<div class="lightbox" x-show="lightboxOpen" x-transition.opacity x-cloak @click.self="lightboxOpen = false">
				<button type="button" class="lightbox__close" @click="lightboxOpen = false">‚úï</button>
				<img src="/exercises/files/image/{{ quizQuestion.imageUrl }}" alt="Exercise image" class="lightbox__img" />
			</div>
		{% endif %}
	</div>

	<script>
		function submitAnswer(data) {
			if (data.isSubmitted || !data.userAnswer.trim()) return;
			var collectionId = document.getElementById('collectionId').value;
			var exerciseId = document.getElementById('exerciseId').value;
			fetch('/exercises/drill/' + collectionId + '/submit', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ exerciseId: exerciseId, userAnswer: data.userAnswer })
			})
			.then(function(res) { return res.json(); })
			.then(function(response) {
				data.isSubmitted = true;
				data.isCorrect = response.isCorrect;
				data.correctAnswer = response.correctAnswer;
				data.additionalAnswers = response.additionalCorrectAnswers || [];
				data.streak = response.streak || 0;
				data.sessionCorrect = response.sessionCorrect || 0;
				data.sessionTotal = response.sessionTotal || 0;
				if (response.isCorrect) {
					var audio = document.getElementById('exercise-audio');
					if (audio) { audio.currentTime = 0; audio.play(); }
				}
				setTimeout(function() {
					var nextBtn = document.querySelector('.quiz-footer__btn--next');
					if (nextBtn) nextBtn.focus();
				}, 100);
			})
			.catch(function(err) {
				console.error('Submit failed:', err);
				if (window.toast) toast.error('Failed to submit answer');
			});
		}
		function nextQuestion() {
			var collectionId = document.getElementById('collectionId').value;
			window.location.href = '/ui/quiz/' + collectionId;
		}
	</script>
{% endblock %}
