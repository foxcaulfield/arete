{% extends "layouts/base.njk" %}
{% import "partials/components.njk" as components %}

{% block content %}
	{# Page Header with Back Button #}
	<div class="page-header page-header--simple">
		<a href="/ui/collections" class="btn-back">â† Collections</a>
	</div>

	{# Collection Info Card #}
	<div class="card collection-card mb">
		<div class="collection-header">
			<div class="collection-header__main">
				<h1 class="collection-header__name">{{ collection.name }}</h1>
				{% if collection.description %}
					<p class="collection-header__description">{{ collection.description }}</p>
				{% endif %}
			</div>
			<div class="collection-header__stats">
				<div class="mini-stat">
					<span class="mini-stat__value">{{ collection.exerciseCount or exercises.pagination.totalItems or 0 }}</span>
					<span class="mini-stat__label">Exercises</span>
				</div>
				<div class="mini-stat {% if (collection.coverage | int) >= 75 %}mini-stat--success{% elif (collection.coverage | int) >= 25 %}mini-stat--warning{% endif %}">
					<span class="mini-stat__value">{{ collection.coverage or 0 }}%</span>
					<span class="mini-stat__label">Coverage</span>
				</div>
				<div class="mini-stat">
					<span class="mini-stat__value">{{ collection.attemptCount or 0 }}</span>
					<span class="mini-stat__label">Attempts</span>
				</div>
			</div>
		</div>

		<div class="collection-meta">
			<div class="collection-meta__item">
				<span class="collection-meta__label">Owner</span>
				<span class="collection-meta__value">{{ collection.user.name }}</span>
			</div>
			<div class="collection-meta__item">
				<span class="collection-meta__label">Created</span>
				<span class="collection-meta__value">{{ collection.createdAt | date('MMM D, YYYY') }}</span>
			</div>
			<div class="collection-meta__item">
				<span class="collection-meta__label">Updated</span>
				<span class="collection-meta__value">{{ collection.updatedAt | date('MMM D, YYYY') }}</span>
			</div>
		</div>

		{# Collection Actions - Single Row #}
		<div class="collection-actions-bar">
			<div class="collection-actions__secondary">
				<a href="/ui/collections/{{ collection.id }}/edit" class="btn-outline">Edit</a>
				<button
					class="btn-outline btn-outline--danger"
					type="button"
					hx-delete="/collections/delete/{{ collection.id }}"
					hx-disabled-elt="this"
					hx-trigger="click"
					hx-swap="none"
					hx-confirm="Are you sure you want to delete this collection and all its exercises?"
					hx-on::after-request="
						if(event.detail.successful){
							toast.success('Collection deleted');
							setTimeout(function(){ window.location='/ui/collections'; }, 800);
						} else {
							try {
								const err=JSON.parse(event.detail.xhr.responseText);
								toast.error('Delete failed: ' + (err.message || 'Unknown error'));
							} catch(e){
								toast.error('Delete failed');
							}
						}"
				>Delete</button>
			</div>
			<div class="collection-actions__primary">
				<a href="/ui/exercises/create?collectionId={{ collection.id }}" class="btn-secondary">+ Add Exercise</a>
				<a href="/ui/quiz/{{ collection.id }}" class="btn-primary">â–¶ Start Quiz</a>
			</div>
		</div>
	</div>

	{# Exercises Section #}
	<div id="exercises-wrapper">
		<div class="section-header">
			<h2>Exercises</h2>
			<span class="section-header__count">{{ exercises.pagination.totalItems }} total</span>
		</div>

		{# Search & Filter Bar #}
		<div class="filter-bar filter-bar--compact">
			<form class="filter-bar__form" id="exercises-filter-form" hx-get="/ui/collections/{{ collection.id }}" hx-target="#exercises-wrapper" hx-select="#exercises-wrapper" hx-push-url="true" hx-trigger="submit">
				<div class="filter-bar__search">
					<input 
						type="text" 
						name="search" 
						placeholder="Search by question or answer..." 
						value="{{ filter.search or '' }}"
						class="filter-bar__input"
						autocomplete="off"
					/>
					<button type="submit" class="filter-bar__submit">Search</button>
				</div>
				<div class="filter-bar__options">
					<select name="type" class="filter-bar__select">
						<option value="">All Types</option>
						<option value="CHOICE_SINGLE" {% if filter.type == 'CHOICE_SINGLE' %}selected{% endif %}>Single Choice</option>
						<option value="FILL_IN_THE_BLANK" {% if filter.type == 'FILL_IN_THE_BLANK' %}selected{% endif %}>Fill in Blank</option>
					</select>
					<select name="sortBy" class="filter-bar__select" title="Sort by">
						<option value="updatedAt" {% if filter.sortBy == 'updatedAt' %}selected{% endif %}>Sort: Updated</option>
						<option value="createdAt" {% if filter.sortBy == 'createdAt' %}selected{% endif %}>Sort: Created</option>
						<option value="question" {% if filter.sortBy == 'question' %}selected{% endif %}>Sort: Question</option>
						<option value="totalAttempts" {% if filter.sortBy == 'totalAttempts' %}selected{% endif %}>Sort: Attempts</option>
					</select>
					<select name="sortOrder" class="filter-bar__select" title="Sort order">
						<option value="desc" {% if filter.sortOrder == 'desc' %}selected{% endif %}>Descending</option>
						<option value="asc" {% if filter.sortOrder == 'asc' %}selected{% endif %}>Ascending</option>
					</select>
					<select name="hasImage" class="filter-bar__select">
						<option value="">ğŸ“· Any</option>
						<option value="has" {% if filter.hasImage == 'has' %}selected{% endif %}>ğŸ“· With Image</option>
						<option value="none" {% if filter.hasImage == 'none' %}selected{% endif %}>ğŸ“· No Image</option>
					</select>
					<select name="hasAudio" class="filter-bar__select">
						<option value="">ğŸµ Any</option>
						<option value="has" {% if filter.hasAudio == 'has' %}selected{% endif %}>ğŸµ With Audio</option>
						<option value="none" {% if filter.hasAudio == 'none' %}selected{% endif %}>ğŸµ No Audio</option>
					</select>
					<select name="limit" class="filter-bar__select">
						<option value="10" {% if exercises.pagination.limit == 10 %}selected{% endif %}>10 / page</option>
						<option value="25" {% if exercises.pagination.limit == 25 %}selected{% endif %}>25 / page</option>
						<option value="50" {% if exercises.pagination.limit == 50 %}selected{% endif %}>50 / page</option>
					</select>
					<button type="submit" class="filter-bar__submit">Apply</button>
				</div>
			</form>
			<div class="filter-bar__hint">
				Press Enter or click Apply to filter results.
				{% if filter.search or filter.type or filter.hasImage or filter.hasAudio %}
					â€” <a href="/ui/collections/{{ collection.id }}" class="filter-bar__clear">Clear filters</a>
				{% endif %}
			</div>
		</div>

		{# Pagination Bar #}
		{% if exercises.data.length %}
			<div class="pagination">
				<span class="pagination__info">{{ exercises.pagination.totalItems }} exercise{% if exercises.pagination.totalItems != 1 %}s{% endif %}</span>

				<div class="pagination__nav">
					{% if exercises.pagination.hasPreviousPage %}
						<button
							type="button"
							hx-get="/ui/collections/{{ collection.id }}?page={{ exercises.pagination.page - 1 }}&limit={{ exercises.pagination.limit }}{% if filter.search %}&search={{ filter.search }}{% endif %}{% if filter.type %}&type={{ filter.type }}{% endif %}{% if filter.hasImage %}&hasImage={{ filter.hasImage }}{% endif %}{% if filter.hasAudio %}&hasAudio={{ filter.hasAudio }}{% endif %}{% if filter.sortBy %}&sortBy={{ filter.sortBy }}{% endif %}{% if filter.sortOrder %}&sortOrder={{ filter.sortOrder }}{% endif %}"
							hx-select="#exercises-wrapper"
							hx-target="#exercises-wrapper"
							hx-push-url="true"
						>â†</button>
					{% else %}
						<button type="button" disabled>â†</button>
					{% endif %}

					<span class="pagination__page pagination__page--current">{{ exercises.pagination.page }}</span>
					<span class="pagination__text">of {{ exercises.pagination.totalPages }}</span>

					{% if exercises.pagination.hasNextPage %}
						<button
							type="button"
							hx-get="/ui/collections/{{ collection.id }}?page={{ exercises.pagination.page + 1 }}&limit={{ exercises.pagination.limit }}{% if filter.search %}&search={{ filter.search }}{% endif %}{% if filter.type %}&type={{ filter.type }}{% endif %}{% if filter.hasImage %}&hasImage={{ filter.hasImage }}{% endif %}{% if filter.hasAudio %}&hasAudio={{ filter.hasAudio }}{% endif %}{% if filter.sortBy %}&sortBy={{ filter.sortBy }}{% endif %}{% if filter.sortOrder %}&sortOrder={{ filter.sortOrder }}{% endif %}"
							hx-select="#exercises-wrapper"
							hx-target="#exercises-wrapper"
							hx-push-url="true"
						>â†’</button>
					{% else %}
						<button type="button" disabled>â†’</button>
					{% endif %}
				</div>
			</div>
		{% endif %}

		{# Exercises Table or Empty State #}
		{% if exercises.data.length %}
			<div class="table-wrapper">
				<table id="exercises-table">
					<thead>
						{{ components.exerciseTableHeader() }}
					</thead>
					<tbody>
						{% for exercise in exercises.data %}
							{{ components.exerciseTableRow(exercise) }}
						{% endfor %}
					</tbody>
				</table>
			</div>
		{% else %}
			<div class="card">
				<div class="empty-state">
					{% if filter.search or filter.type %}
						<div class="empty-state__icon">ğŸ”</div>
						<div class="empty-state__title">No exercises found</div>
						<p class="empty-state__text">Try adjusting your search or <a href="/ui/collections/{{ collection.id }}">clear filters</a>.</p>
					{% else %}
						<div class="empty-state__icon">ğŸ“</div>
						<div class="empty-state__title">No exercises yet</div>
						<p class="empty-state__text">Click "+ Add Exercise" above to create your first one.</p>
					{% endif %}
				</div>
			</div>
		{% endif %}
	</div>
{% endblock %}